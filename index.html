<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Math Sprint â€” Head-to-Head</title>
<style>
  /* your CSS exactly as before */
</style>
</head>
<body>
  <!-- your HTML exactly as before -->
<script>
(function(){
  // ===== DOM =====
  var $=function(s){return document.querySelector(s);}
  var elMode=$('#mode'), elDiff=$('#difficulty'), elDiffVal=$('#diffVal');
  var elTimerSec=$('#timerSec'), elTimerVal=$('#timerVal');
  var elRounds=$('#rounds'), elPlayers=$('#players');
  var elNameP1=$('#nameP1'), elNameP2=$('#nameP2');

  var elMusicOn=$('#musicOn'), elMusicVol=$('#musicVol'), BGM=$('#bgm');
  var elSoundOn=$('#soundOn'), elVol=$('#volume'), SND_OK=$('#sndCorrect'), SND_NO=$('#sndWrong');

  var elStart=$('#btnStart'), elReset=$('#btnReset');
  var elSingle=$('#singleRows'), elMulti=$('#multiRows');
  var elAns1=$('#answer1'), elBtn1=$('#btnSubmit1');
  var elP1=$('#answerP1'), elP2=$('#answerP2');
  var elBtnP1=$('#btnSubmitP1'), elBtnP2=$('#btnSubmitP2');
  var rowP1=$('#rowP1'), rowP2=$('#rowP2');

  var elFormula=$('#formula'), elFeedback=$('#feedback');
  var elStatGood=$('#statGood'), elStatBad=$('#statBad'), elStatAcc=$('#statAcc');
  var elQIndex=$('#qIndex'), elTimer=$('#timer');
  var elVersus=$('#versus'), elP1Score=$('#p1Score'), elP2Score=$('#p2Score'), elLead=$('#lead');
  var elLblP1=$('#lblP1'), elLblP2=$('#lblP2'), elTurn=$('#turnBanner');

  var fxGood=$('#fxGood'), fxBad=$('#fxBad'), fxGoodImg=$('#fxGoodImg'), fxBadImg=$('#fxBadImg');

  // Turn overlay
  var overlay=$('#turnOverlay'), overlayText=$('#turnText'), overlayAvatar=$('#turnAvatar'), btnBeginTurn=$('#btnBeginTurn');

  // Final overlay
  var finalOv = $('#finalOverlay'), finalCard = $('#finalCard');
  var finalScore = $('#finalScore'), finalClose = $('#finalClose');
  function showFinal(text){ finalScore.textContent=text; finalOv.classList.add('show'); finalOv.setAttribute('aria-hidden','false'); }
  function hideFinal(){ finalOv.classList.remove('show'); finalOv.setAttribute('aria-hidden','true'); }
  finalClose.addEventListener('click', hideFinal);
  finalOv.addEventListener('click', function(e){ if(e.target===finalOv) hideFinal(); });
  window.addEventListener('keydown', function(e){ if(e.key==='Escape') hideFinal(); });

  // ===== State =====
  var GOOD_CANDIDATES=["images/Macky-Correct-2.jpg","images/IMG-20250628-WA0014[1].png","images/correct.png","images/correct1.webp"];
  var BAD_CANDIDATES =["images/Macky-Incorrect-1.png","images/wrong.png","images/wrong1.webp"];
  var GOOD_IMGS=[], BAD_IMGS=[];
  var P1_IMG="players/p1.png";
  var P2_IMG="players/p2.png";

  var running=false, current=null, qCount=0;
  var good=0,bad=0;
  var p1={ok:0,no:0,played:0}, p2={ok:0,no:0,played:0};
  var tick=null, remaining=0;
  var turn='p1';
  var awaitingTurnStart=false;

  // ===== preload images =====
  function filterExisting(candidates, cb){
    var out=[], i=0;
    function tryNext(){
      if(i>=candidates.length){ cb(out); return; }
      var src=candidates[i++], img=new Image();
      img.onload=function(){ out.push(src); tryNext(); };
      img.onerror=tryNext; img.src=src;
    }
    tryNext();
  }
  filterExisting(GOOD_CANDIDATES,function(arr){ GOOD_IMGS=arr.length?arr:GOOD_CANDIDATES.slice(0,1); fxGoodImg.src=GOOD_IMGS[0]; });
  filterExisting(BAD_CANDIDATES, function(arr){ BAD_IMGS =arr.length?arr:BAD_CANDIDATES.slice(0,1);  fxBadImg.src =BAD_IMGS[0]; });

  // ===== Music =====
  function updateMusic(){
    BGM.volume=+elMusicVol.value;
    if(elMusicOn.value==="1"){
      BGM.play().catch(function(){});
    }else{
      BGM.pause(); BGM.currentTime=0;
    }
  }
  elMusicOn.addEventListener('change',updateMusic);
  elMusicVol.addEventListener('input',updateMusic);

  // ===== Sound FX =====
  var AC=(window.AudioContext||window.webkitAudioContext)? new (window.AudioContext||window.webkitAudioContext)() : null;
  var master=AC? AC.createGain():null; if(master){ master.connect(AC.destination); master.gain.value=+elVol.value; }
  function soundOn(){ return elSoundOn.value==="1"; }
  elVol.addEventListener('input',function(){ if(master) master.gain.value=+elVol.value; });

  function tone(freq,dur,type,when,vol){
    if(!soundOn() || !AC) return;
    dur = dur||0.12; type=type||'sine'; when=when||0; vol=vol||0.2;
    var o=AC.createOscillator(), g=AC.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master);
    var t=AC.currentTime+when; o.start(t);
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.stop(t+dur+0.02);
  }
  function playAudio(el){
    if(!soundOn() || !el) return;
    try{ el.currentTime=0; el.volume=+elVol.value; el.play(); }catch(e){}
  }
  var sfx={
    correct:function(){ playAudio(SND_OK); },
    wrong:function(){ playAudio(SND_NO); },
    tick:function(){ tone(900,0.03,'square',0,0.12); },
    timeout:function(){ [523,392,330].forEach(function(f,i){tone(f,0.12,'sine',i*0.09,0.22);}); }
  };

  // ===== Math =====
  function clamp(n,a,b){return Math.min(Math.max(n,a),b);}
  function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
  function pickOp(m){return m!=='mix'?m:['add','sub','mul','div'][rnd(0,3)];}
  function rangeFor(op,L){
    L=clamp(+L,1,10);
    var add=[9,12,20,30,40,60,90,120,180,250][L-1];
    var mul=[5,6,8,9,10,12,15,18,20,25][L-1];
    if(op==='mul') return {min:0,max:mul};
    if(op==='div') return {min:1,max:mul};
    return {min:0,max:add};
  }
  var ops={
    add:{gen:function(L){var r=rangeFor('add',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:a+" + "+b,answer:a+b};}},
    sub:{gen:function(L){var r=rangeFor('sub',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);if(b>a){var t=a;a=b;b=t;}return {text:a+" âˆ’ "+b,answer:a-b};}},
    mul:{gen:function(L){var r=rangeFor('mul',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:a+" Ã— "+b,answer:a*b};}},
    div:{gen:function(L){var r=rangeFor('div',L),b=rnd(r.min,r.max),q=rnd(r.min,r.max),a=b*q;return {text:a+" Ã· "+b,answer:q};}}
  };

  // ===== Helpers =====
  function flash(el,list,hold){
    hold = hold||600;
    var pick=list[rnd(0,list.length-1)];
    (el===fxGood?fxGoodImg:fxBadImg).src=pick;
    el.classList.add('show'); setTimeout(function(){el.classList.remove('show');},hold);
  }
  function accuracy(){ var t=good+bad; return !t?'â€”':Math.round((good/t)*100); }
  function updateStats(){
    elStatGood.textContent=good; elStatBad.textContent=bad;
    var acc=accuracy(); elStatAcc.textContent=acc==='â€”'?'â€”':(acc+'%');
  }

  function activeName(){ return turn==='p1' ? (elNameP1.value||'Player 1') : (elNameP2.value||'Player 2'); }
  function updateTurnBanner(){ elTurn.textContent = elPlayers.value==='2' ? ('Turn: '+activeName()) : 'â€”'; }
  function setRowVis(){
    var p1Active = (turn==='p1');
    rowP1.classList.toggle('hidden',!p1Active);
    rowP2.classList.toggle('hidden', p1Active);
    elP1.disabled=!p1Active; elP2.disabled=p1Active;
    (p1Active?elP1:elP2).focus();
  }

  // ===== UI mode =====
  function uiMode(){
    var two = elPlayers.value==="2";
    elSingle.style.display = two ? 'none':'grid';
    elMulti .style.display = two ? 'grid':'none';
    elVersus.style.display = two ? 'grid':'none';
    elLblP1.textContent=(elNameP1.value||'Player 1')+' âœ“ / âœ—';
    elLblP2.textContent=(elNameP2.value||'Player 2')+' âœ“ / âœ—';
    $('#answerP1').placeholder = (elNameP1.value||'Player 1');
    $('#answerP2').placeholder = (elNameP2.value||'Player 2');
    updateTurnBanner();
    if(two) setRowVis();
  }
  elPlayers.addEventListener('change',uiMode);
  elNameP1.addEventListener('input',uiMode);
  elNameP2.addEventListener('input',uiMode);

  // ===== Turn overlay =====
  function showTurnOverlay(){
    if(elPlayers.value!=='2') return;
    overlayText.textContent = 'Next up: ' + activeName();
    overlayAvatar.src = (turn==='p1')? P1_IMG : P2_IMG;
    overlayAvatar.onerror = function(){ overlayAvatar.style.display='none'; };
    overlayAvatar.onload  = function(){ overlayAvatar.style.display='block'; };
    overlay.classList.add('show');
    awaitingTurnStart = true;
  }
  function hideTurnOverlay(){ overlay.classList.remove('show'); awaitingTurnStart=false; }

  btnBeginTurn.addEventListener('click', function(){
    hideTurnOverlay();
    if(elMusicOn.value==="1"){ try{ BGM.volume=+elMusicVol.value; BGM.play(); }catch(e){} }

    // RESET per-player question counter at the start of each player's turn
    qCount = 0;
    elQIndex.textContent = '0';

    // ðŸ”§ RESET the global totals shown for the new player's turn
    if (elPlayers.value === '2') {
      good = 0;
      bad  = 0;
      updateStats();
    }

    setRowVis();
    next(true);
  });
  window.addEventListener('keydown', function(e){
    if(awaitingTurnStart && (e.key===' ' || e.key==='Enter')){ e.preventDefault(); btnBeginTurn.click(); }
  });

  /* rest of your JS unchanged ... */
})();
</script>
</body>
</html>
