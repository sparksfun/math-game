<script>
(function(){
  // ===== Constants =====
  const NAME_P1 = 'Aliah';
  const NAME_P2 = 'Aliana';

  // --- Music pool (filenames inside /sounds) ---
  const MUSIC_TRACKS = [
    "Confused and Angry Robots.mp3",
    "Delightful Stroll.mp3",
    "Forest Theme - D Minor - Jordan Ottesen.mp3",
    "Rainbow Lollipop.mp3",
    "Space Knights.mp3",
    "Water Theme - G Major - Jordan Ottesen.mp3"
  ];
  function setRandomBgm(){
    if (!MUSIC_TRACKS.length) return;
    const pick = MUSIC_TRACKS[Math.floor(Math.random()*MUSIC_TRACKS.length)];
    BGM.src = "sounds/" + pick;
    console.log('BGM src:', BGM.src);
  }
  function attemptAutoplay(){
    BGM.volume = +elMusicVol.value;
    BGM.play().catch(() => {
      const resume = () => {
        if (AC && AC.state === 'suspended') AC.resume();
        BGM.play().catch(()=>{});
        document.removeEventListener('pointerdown', resume);
        document.removeEventListener('keydown', resume);
      };
      document.addEventListener('pointerdown', resume, { once:true });
      document.addEventListener('keydown',   resume, { once:true });
    });
  }

  // ===== DOM =====
  var $=function(s){return document.querySelector(s);}
  var elMode=$('#mode'), elDiff=$('#difficulty'), elDiffVal=$('#diffVal');
  var elTimerSec=$('#timerSec'), elTimerVal=$('#timerVal');
  var elRounds=$('#rounds'), elPlayers=$('#players');

  var elMusicOn=$('#musicOn'), elMusicVol=$('#musicVol'), BGM=$('#bgm');
  var elSoundOn=$('#soundOn'), elVol=$('#volume'),
      SND_OK=$('#sndCorrect'), SND_NO=$('#sndWrong'), SND_FINISH=$('#sndFinish');
  // NEW: UI action sounds
  var SND_START=$('#sndStart'), SND_SINGLE=$('#sndSingle'), SND_HEAD=$('#sndHead');

  var elStart=$('#btnStart'), elReset=$('#btnReset');
  var elSingle=$('#singleRows'), elMulti=$('#multiRows');
  var elAns1=$('#answer1'), elBtn1=$('#btnSubmit1');
  var elP1=$('#answerP1'), elP2=$('#answerP2');
  var elBtnP1=$('#btnSubmitP1'), elBtnP2=$('#btnSubmitP2');
  var rowP1=$('#rowP1'), rowP2=$('#rowP2');

  var elFormula=$('#formula'), elFeedback=$('#feedback');
  var elQIndex=$('#qIndex'), elTimer=$('#timerMini'); // <-- timer now inside the problem area
  var elVersus=$('#versus'), elP1Score=$('#p1Score'), elP2Score=$('#p2Score'), elLead=$('#lead');
  var elLblP1=$('#lblP1'), elLblP2=$('#lblP2'), elTurn=$('#turnBanner');

  var fxGood=$('#fxGood'), fxBad=$('#fxBad'), fxGoodImg=$('#fxGoodImg'), fxBadImg=$('#fxBadImg');

  // Turn overlay
  var overlay=$('#turnOverlay'), overlayText=$('#turnText'), overlayAvatar=$('#turnAvatar'), btnBeginTurn=$('#btnBeginTurn');

  // Final overlay
  var finalOv = $('#finalOverlay'), finalCard = $('#finalCard');
  var finalScore = $('#finalScore'), finalClose = $('#finalClose');
  function showFinal(text){ finalScore.textContent=text; finalOv.classList.add('show'); finalOv.setAttribute('aria-hidden','false'); }
  function hideFinal(){ finalOv.classList.remove('show'); finalOv.setAttribute('aria-hidden','true'); }
  finalClose.addEventListener('click', hideFinal);
  finalOv.addEventListener('click', function(e){ if(e.target===finalOv) hideFinal(); });
  window.addEventListener('keydown', function(e){ if(e.key==='Escape') hideFinal(); });

  // ===== State =====
  var GOOD_CANDIDATES=["images/Macky-Correct-2.jpg","images/IMG-20250628-WA0014[1].png","images/correct.png","images/correct1.webp"];
  var BAD_CANDIDATES =["images/Macky-Incorrect-1.png","images/wrong.png","images/wrong1.webp"];
  var GOOD_IMGS=[], BAD_IMGS=[];
  var P1_IMG="players/p1.png";
  var P2_IMG="players/p2.png";

  var running=false, current=null, qCount=0;
  var good=0,bad=0;
  var p1={ok:0,no:0,played:0}, p2={ok:0,no:0,played:0};
  var tick=null, remaining=0;
  var turn='p1';
  var awaitingTurnStart=false;

  // ===== preload & filter available images =====
  // 1x1 transparent PNG fallback
  var BLANK_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";

  function filterExisting(candidates, cb){
    var out=[], i=0;
    function tryNext(){
      if(i>=candidates.length){ cb(out); return; }
      var src=candidates[i++], img=new Image();
      img.onload=function(){ out.push(src); tryNext(); };
      img.onerror=tryNext; img.src=src;
    }
    tryNext();
  }
  filterExisting(GOOD_CANDIDATES,function(arr){ GOOD_IMGS=arr.length?arr:[BLANK_IMG]; fxGoodImg.src=GOOD_IMGS[0]; });
  filterExisting(BAD_CANDIDATES, function(arr){ BAD_IMGS =arr.length?arr:[BLANK_IMG];  fxBadImg.src =BAD_IMGS[0]; });

  // ===== Music =====
  function updateMusic(){
    BGM.volume=+elMusicVol.value;
    if(elMusicOn.value==="1"){
      BGM.play().catch(function(){});
    }else{
      BGM.pause();
    }
  }
  elMusicOn.addEventListener('change',updateMusic);
  elMusicVol.addEventListener('input',updateMusic);

  // ===== Sound FX (oscillator + file playback) =====
  var AC=(window.AudioContext||window.webkitAudioContext)? new (window.AudioContext||window.webkitAudioContext)() : null;
  var master=AC? AC.createGain():null; if(master){ master.connect(AC.destination); master.gain.value=+elVol.value; }
  function soundOn(){ return elSoundOn.value==="1"; }
  elVol.addEventListener('input',function(){ if(master) master.gain.value=+elVol.value; });

  function tone(freq,dur,type,when,vol){
    if(!soundOn() || !AC) return;
    dur = dur||0.12; type=type||'sine'; when=when||0; vol=vol||0.2;
    var o=AC.createOscillator(), g=AC.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master);
    var t=AC.currentTime+when; o.start(t);
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.stop(t+dur+0.02);
  }
  function playAudio(el){
    if(!soundOn() || !el) return;
    try{ el.currentTime=0; el.volume=+elVol.value; el.play(); }catch(e){}
  }
  var sfx={
    correct:function(){ playAudio(SND_OK); },
    wrong:function(){ playAudio(SND_NO); },
    tick:function(){ tone(900,0.03,'square',0,0.12); },
    timeout:function(){ [523,392,330].forEach(function(f,i){tone(f,0.12,'sine',i*0.09,0.22);}); }
  };

  // ===== GIF duration helper (auto-hold for GIFs only) =====
  var GIF_CACHE = Object.create(null);
  function isGif(src){ return /\.gif(?:$|\?)/i.test(src); }

  async function getGifDurationMs(url){
    if (GIF_CACHE[url]) return GIF_CACHE[url];
    const resp = await fetch(url, {cache:'force-cache'});
    const buf = await resp.arrayBuffer();
    const u = new Uint8Array(buf);

    // Parse minimal GIF: sum frame delays from Graphic Control Extensions
    let p = 0, totalCs = 0, gceDelayCs = 0;
    // Header "GIF87a"/"GIF89a"
    p += 6;
    if (p+7 > u.length) return (GIF_CACHE[url] = 1000);
    // Logical Screen Descriptor
    const packedLSD = u[p+4];
    p += 7;
    // Global Color Table
    if (packedLSD & 0x80){
      const gctSize = 3 * (1 << ((packedLSD & 0x07) + 1));
      p += gctSize;
    }
    // Blocks
    while (p < u.length){
      const b = u[p++];
      if (b === 0x3B) break; // trailer
      if (b === 0x21){ // extension
        const label = u[p++];
        if (label === 0xF9){ // GCE
          const blockSize = u[p++]; // should be 4
          if (blockSize >= 4){
            const packed = u[p]; // not used
            const delayLo = u[p+1], delayHi = u[p+2];
            const delayCs = (delayHi << 8) | delayLo; // centiseconds
            // Some encoders use 0; clamp to a sensible minimum (3 cs = 30ms)
            gceDelayCs = Math.max(delayCs, 3);
          }
          p += blockSize;
          p++; // block terminator
        } else {
          // skip generic extension sub-blocks
          while (true){
            const sz = u[p++];
            if (sz === 0) break;
            p += sz;
          }
        }
      } else if (b === 0x2C){ // image descriptor = frame
        // consume image descriptor (10 bytes)
        if (p+9 > u.length) break;
        const packedID = u[p+8];
        p += 9;
        // local color table
        if (packedID & 0x80){
          const lctSize = 3 * (1 << ((packedID & 0x07) + 1));
          p += lctSize;
        }
        // LZW min code size
        p++;
        // image data sub-blocks
        while (true){
          const sz = u[p++];
          if (sz === 0) break;
          p += sz;
        }
        // add last seen GCE delay for this frame
        totalCs += (gceDelayCs || 3);
      } else {
        // unknown block: bail
        break;
      }
    }
    // Convert centiseconds -> ms; clamp to 600ms min to avoid instant hide on tiny gifs
    const ms = Math.max(totalCs * 10, 600);
    GIF_CACHE[url] = ms;
    return ms;
  }

  // ===== Helpers =====
  // NOTE: flash() now auto-extends hold *only for GIFs* by parsing their duration.
  async function flash(el, list, hold){
    hold = hold || 600;
    try{
      var imgEl = (el === fxGood ? fxGoodImg : fxBadImg);
      var pick  = (list && list.length) ? list[Math.floor(Math.random() * list.length)] : BLANK_IMG;
      imgEl.src = pick;
      el.classList.add('show');

      var ms = hold;
      if (isGif(pick)){
        try {
          const gifMs = await getGifDurationMs(pick);
          // Use the longer of requested hold and GIF duration (+ small buffer)
          ms = Math.max(hold, gifMs + 150);
        } catch(_) { /* fall back to hold */ }
      }
      setTimeout(function(){ el.classList.remove('show'); }, ms);
    }catch(e){
      el.classList.add('show');
      setTimeout(function(){ el.classList.remove('show'); }, hold);
    }
  }

  function clamp(n,a,b){return Math.min(Math.max(n,a),b);}
  function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
  function pickOp(m){return m!=='mix'?m:['add','sub','mul','div'][rnd(0,3)];}
  function rangeFor(op,L){
    L=clamp(+L,1,10);
    var add=[9,12,20,30,40,60,90,120,180,250][L-1];
    var mul=[5,6,8,9,10,12,15,18,20,25][L-1];
    if(op==='mul') return {min:0,max:mul};
    if(op==='div') return {min:1,max:mul};
    return {min:0,max:add};
  }
  function accuracy(){
    var t = good + bad;
    return t ? Math.round((good / t) * 100) : '—';
  }
  var ops={
    add:{gen:function(L){var r=rangeFor('add',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:a+" + "+b,answer:a+b};}},
    sub:{gen:function(L){var r=rangeFor('sub',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);if(b>a){var t=a;a=b;b=t;}return {text:a+" − "+b,answer:a-b};}},
    mul:{gen:function(L){var r=rangeFor('mul',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:a+" × "+b,answer:a*b};}},
    div:{gen:function(L){var r=rangeFor('div',L),b=rnd(r.min,r.max),q=rnd(r.min,r.max),a=b*q;return {text:a+" ÷ "+b,answer:q};}}
  };

  // ===== UI mode / turn handling =====
  function activeName(){ return turn==='p1' ? NAME_P1 : NAME_P2; }
  function updateTurnBanner(){ elTurn.textContent = elPlayers.value==='2' ? ('Turn: '+activeName()) : '—'; }
  function setRowVis(){
    var p1Active = (turn==='p1');
    rowP1.classList.toggle('hidden',!p1Active);
    rowP2.classList.toggle('hidden', p1Active);
    elP1.disabled=!p1Active; elP2.disabled=p1Active;
    (p1Active?elP1:elP2).focus();
  }
  function uiMode(){
    var two = elPlayers.value==="2";
    elSingle.style.display = two ? 'none':'grid';
    elMulti .style.display = two ? 'grid':'none';
    elVersus.style.display = two ? 'grid':'none';
    elLblP1.textContent= NAME_P1+' ✓ / ✗';
    elLblP2.textContent= NAME_P2+' ✓ / ✗';
    $('#answerP1').placeholder = NAME_P1;
    $('#answerP2').placeholder = NAME_P2;
    updateTurnBanner();
    if(two) setRowVis();
  }

  // Play audio when player mode changes
  elPlayers.addEventListener('change', function(){
    if (elPlayers.value === "1") playAudio(SND_SINGLE);
    else if (elPlayers.value === "2") playAudio(SND_HEAD);
    uiMode();
  });

  function showTurnOverlay(){
    if(elPlayers.value!=='2') return;
    overlayText.textContent = 'Next up: ' + activeName();
    overlayAvatar.src = (turn==='p1')? P1_IMG : P2_IMG;
    overlayAvatar.onerror = function(){ overlayAvatar.style.display='none'; };
    overlayAvatar.onload  = function(){ overlayAvatar.style.display='block'; };
    overlay.classList.add('show');
    awaitingTurnStart = true;
  }
  function hideTurnOverlay(){ overlay.classList.remove('show'); awaitingTurnStart=false; }

  // Handoff: re-roll music
  btnBeginTurn.addEventListener('click', function(){
    hideTurnOverlay();
    setRandomBgm();
    attemptAutoplay();
    qCount = 0; elQIndex.textContent = '0';
    setRowVis();
    next(true);
  });
  window.addEventListener('keydown', function(e){
    if(awaitingTurnStart && (e.key===' ' || e.key==='Enter')){ e.preventDefault(); btnBeginTurn.click(); }
  });

  // ===== Core flow (rounds per player) =====
  function everyonePlayed(){ var r=parseInt(elRounds.value,10); return (p1.played>=r && p2.played>=r); }
  function sessionFinishedFor(id){ var r=parseInt(elRounds.value,10); return (id==='p1'?p1:p2).played>=r; }

  function start(){
    if(running) return;
    if(AC && AC.state==='suspended'){ AC.resume(); }
    running=true; qCount=0; good=bad=0; p1={ok:0,no:0,played:0}; p2={ok:0,no:0,played:0};
    elStart.textContent='Running…'; elStart.disabled=true;

    // start button sound
    playAudio(SND_START);

    // Match start: re-roll music
    setRandomBgm();
    attemptAutoplay();

    if(elPlayers.value==="2"){
      turn = (Math.random()<0.5)?'p1':'p2';
      updateTurnBanner();
      qCount = 0; elQIndex.textContent = '0';
      showTurnOverlay();
    }else{
      elAns1.disabled=false; next(true); elAns1.focus();
    }
    uiMode();
  }
  function reset(){
    stopTimer(); running=false; current=null; qCount=good=bad=0; p1={ok:0,no:0,played:0}; p2={ok:0,no:0,played:0};
    elStart.textContent='Start ▶'; elStart.disabled=false;
    [elAns1,elP1,elP2].forEach(function(i){i.value=''; i.disabled=true;});
    elFormula.textContent='—'; elFeedback.textContent=' '; elFeedback.className='feedback'; elTimer.textContent='Timer: off';
    elP1Score.textContent='0 / 0'; elP2Score.textContent='0 / 0'; elLead.textContent='—';
    elQIndex.textContent='0';
    overlay.classList.remove('show'); awaitingTurnStart=false;
    // NOTE: do not pause BGM here
  }

  function next(initial){
    if(awaitingTurnStart) return;
    stopTimer();

    if (elPlayers.value === '2') {
      if (!initial && sessionFinishedFor(turn)) {
        if (everyonePlayed()) return finish();
        turn = (turn === 'p1') ? 'p2' : 'p1';
        updateTurnBanner();
        showTurnOverlay();
        return;
      }
    } else {
      var maxQ = parseInt(elRounds.value, 10);
      if (!initial && qCount >= maxQ) return finish();
    }

    qCount++;
    var mode=pickOp(elMode.value), L=+elDiff.value;
    current=ops[mode].gen(L);
    elFormula.textContent = current.text;
    elQIndex.textContent=qCount;
    [elAns1,elP1,elP2].forEach(function(i){i.value='';});
    elFeedback.textContent=' '; elFeedback.className='feedback';
    startTimerIfNeeded();
  }

  function finish(){
    if (SND_FINISH) { try { SND_FINISH.currentTime = 0; SND_FINISH.play(); } catch(e){} }
    stopTimer(); running=false; elStart.textContent='Start ▶'; elStart.disabled=false;

    var scoreLine = '';
    if(elPlayers.value==='2'){
      var p1Score=p1.ok, p2Score=p2.ok;
      var n1=NAME_P1, n2=NAME_P2;
      var winner;
      if(p1Score>p2Score) winner = n1 + ' wins!';
      else if(p2Score>p1Score) winner = n2 + ' wins!';
      else {
        var t1=p1.no,t2=p2.no;
        winner = (t1<t2 ? (n1+' wins by fewer mistakes!') :
                 (t2<t1 ? (n2+' wins by fewer mistakes!') : 'It’s a tie!'));
      }
      scoreLine = winner + ' ('+n1+' '+p1.ok+'/'+p1.no+' vs '+n2+' '+p2.ok+'/'+p2.no+')';
    }else{
      var t = good + bad;
      var acc = t ? Math.round((good / t) * 100) : '—';
      scoreLine = good+' correct, '+bad+' wrong, accuracy '+(acc==='—'?'—':acc+'%');
    }

    elFeedback.textContent=' ';
    elFeedback.className='feedback';
    showFinal(scoreLine);
  }

  // ===== Answer submit =====
  function consumeRound(){ if(elPlayers.value==='2'){ (turn==='p1'?p1:p2).played++; } }
  function leadText(){ var d=p1.ok-p2.ok; return d===0?'Tied':(d>0?(NAME_P1)+' +'+d:(NAME_P2)+' +'+(-d)); }

  function handleSubmit(val, who){
    if(awaitingTurnStart) return;
    if(!running || !current || val==='') return;

    stopTimer();

    var num = Number(val);
    var correct = (num === current.answer);

    if (correct) {
      good++;
      if (who === 'p1'){ p1.ok++; elP1Score.textContent = p1.ok + ' / ' + p1.no; elLead.textContent = leadText(); }
      if (who === 'p2'){ p2.ok++; elP2Score.textContent = p2.ok + ' / ' + p2.no; elLead.textContent = leadText(); }
      elFeedback.textContent = (who==='solo' ? 'Correct!' : (activeName() + ' scores!'));
      elFeedback.className = 'feedback ok';
      sfx.correct(); flash(fxGood, GOOD_IMGS, 400);

      consumeRound();
      setTimeout(function(){ next(); }, 180);
      return;
    }

    bad++;
    if (who === 'p1'){ p1.no++; elP1Score.textContent = p1.ok + ' / ' + p1.no; elLead.textContent = leadText(); }
    if (who === 'p2'){ p2.no++; elP2Score.textContent = p2.ok + ' / ' + p2.no; elLead.textContent = leadText(); }
    elFeedback.textContent = '✗ Wrong';
    elFeedback.className = 'feedback no';
    sfx.wrong(); flash(fxBad, BAD_IMGS, 450);

    consumeRound();
    setTimeout(function(){ next(); }, 200);
  }

  function skip(){
    if(awaitingTurnStart || !running) return;
    stopTimer();
    bad++;
    elFeedback.textContent='⏭ Skipped';
    elFeedback.className='feedback no';
    flash(fxBad, BAD_IMGS, 300);
    consumeRound();
    next();
  }

  // ===== Timer =====
  function startTimerIfNeeded(){
    var sec=+elTimerSec.value;
    if(!sec){ elTimer.textContent='Timer: off'; elTimer.style.color='var(--ink)'; return; }
    remaining=sec; renderTimer(); stopTimer();
    tick=setInterval(function(){
      remaining--;
      if(remaining>0){ sfx.tick(); renderTimer(); return; }
      bad++;
      elFeedback.textContent='Time out — next!'; elFeedback.className='feedback no';
      sfx.timeout(); flash(fxBad,BAD_IMGS,700);
      consumeRound(); next();
    },1000);
  }
  function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }
  function renderTimer(){
    var warn=remaining<=Math.max(3,Math.floor(+elTimerSec.value*0.25));
    elTimer.textContent='⏱ '+remaining+'s'; elTimer.style.color=warn?'var(--warn)':'var(--ink)';
  }

  // ===== Events =====
  elDiff.addEventListener('input',function(){ elDiffVal.textContent=elDiff.value; });
  elTimerSec.addEventListener('input',function(){ elTimerVal.textContent=elTimerSec.value+'s'; });

  elStart.addEventListener('click',start);
  elReset.addEventListener('click',reset);

  elBtn1.addEventListener('click',function(){ handleSubmit(elAns1.value.trim(),'solo'); });
  elBtnP1.addEventListener('click',function(){ if(elPlayers.value==='2' && turn==='p1') handleSubmit(elP1.value.trim(),'p1'); });
  elBtnP2.addEventListener('click',function(){ if(elPlayers.value==='2' && turn==='p2') handleSubmit(elP2.value.trim(),'p2'); });

  elAns1.addEventListener('keydown',function(e){ if(e.key==='Enter')handleSubmit(elAns1.value.trim(),'solo'); if(e.key==='Escape')elAns1.value=''; });
  elP1  .addEventListener('keydown',function(e){ if(e.key==='Enter'&&turn==='p1')handleSubmit(elP1.value.trim(),'p1'); if(e.key==='Escape')elP1.value=''; });
  elP2  .addEventListener('keydown',function(e){ if(e.key==='Enter'&&turn==='p2')handleSubmit(elP2.value.trim(),'p2'); if(e.key==='Escape')elP2.value=''; });

  window.addEventListener('keydown',function(e){
    if(e.key && e.key.toLowerCase()==='s') skip();
  });

  // numeric-only
  [elAns1,elP1,elP2].forEach(function(inp){
    inp.addEventListener('input',function(){ inp.value=inp.value.replace(/[^\d-]/g,'').replace(/(?!^)-/g,''); });
  });

  // ===== Init (app load): pick & start music immediately =====
  setRandomBgm();
  attemptAutoplay();

  // init visuals
  fxGoodImg.src = "images/Macky-Correct-2.jpg";
  fxBadImg.src  = "images/Macky-Incorrect-1.png";
  stopTimer(); running=false; current=null; qCount=0;
  elFormula.textContent='—'; elFeedback.textContent=' '; elFeedback.className='feedback'; elTimer.textContent='Timer: off';
  elP1Score.textContent='0 / 0'; elP2Score.textContent='0 / 0'; elLead.textContent='—';
  elQIndex.textContent='0';
  uiMode();
})();
</script>
