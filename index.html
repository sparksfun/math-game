<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Math Sprint — Head-to-Head (Rounds)</title>
<style>
  :root{--bg:#0f1220;--panel:#161a2e;--ink:#e9ecf1;--muted:#aab3c5;--good:#38d39f;--bad:#ff6b6b;--warn:#ffb020;--chip:#232843}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:radial-gradient(1200px 800px at 10% -10%,#1b2142 0%,var(--bg) 55%);color:var(--ink);display:grid;place-items:start center}
  .wrap{width:min(1000px,96vw);margin:28px 0 56px}
  header{display:grid;gap:12px;grid-template-columns:1fr auto;align-items:start;margin-bottom:16px}
  h1{font-weight:800;margin:0;letter-spacing:.2px;font-size:clamp(20px,2.8vw,28px)}

  /* Controls */
  .controls{display:grid;gap:10px;padding:14px;background:color-mix(in oklab,var(--panel),#000 6%);border:1px solid #262b4a;border-radius:14px;grid-template-columns:repeat(8,minmax(0,1fr));align-items:end}
  .group{display:grid;gap:6px} label{font-size:12px;color:var(--muted);letter-spacing:.2px}
  select,input[type="range"],input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2c335a;background:#0e1330;color:var(--ink);outline:none}
  .range-row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px}
  .chip{background:var(--chip);border:1px solid #2b3155;border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}

  /* Names row full width, with inline avatar previews */
  .group.names{grid-column:1 / -1}
  .names-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .namebox{display:grid;grid-template-columns:auto 1fr;align-items:center;gap:8px}
  .name-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid #2b3155}

  #nameP1,#nameP2{min-width:220px;font-size:16px}

  .btn{appearance:none;border:1px solid #2c335a;background:linear-gradient(180deg,#1e2550,#141a3b);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;letter-spacing:.2px;transition:transform .03s ease,filter .15s ease,border-color .15s ease}
  .btn:hover{filter:brightness(1.08);border-color:#3a4381} .btn:active{transform:translateY(1px) scale(.997)}
  .btn.ghost{background:#0e1330;color:var(--muted)} .btn.good{background:linear-gradient(180deg,#16553f,#103c2d);border-color:#1f6b4f;color:#d3ffe9}

  .grid{display:grid;grid-template-columns:3fr 2fr;gap:16px;align-items:stretch}
  .card{background:var(--panel);border:1px solid #262b4a;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .problem{display:grid;justify-items:center;align-content:center;gap:16px;background:radial-gradient(600px 340px at 50% -30%,#1a2150 0%,#121633 60%,#0f1329 100%);border-radius:12px;border:1px solid #262b4a;padding:16px;position:relative}
  .formula{font-size:clamp(36px,6vw,64px);font-weight:800;letter-spacing:1px}
  .turn{font-weight:700;color:#a7b4ff}

  .answer-rows{display:grid;gap:10px;width:min(560px,96%)}
  .row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
  .row input{padding:12px 14px;border-radius:12px;border:1px solid #2c335a;outline:none;background:#0e1330;color:#fff;font-size:clamp(18px,2.2vw,22px);text-align:center;letter-spacing:.5px}
  .p1{border-left:4px solid #6bd3ff;padding-left:8px;border-radius:10px} .p2{border-left:4px solid #ffb86b;padding-left:8px;border-radius:10px}
  .hidden{display:none !important}

  /* Active-row avatar */
  .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #2b3155}

  .feedback{height:28px;font-weight:700;letter-spacing:.3px}
  .feedback.ok{color:var(--good)} .feedback.no{color:var(--bad)}

  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
  .stat{background:#0e1330;border:1px solid #2b3155;border-radius:12px;padding:10px 12px;display:grid;gap:4px} .stat b{font-size:22px}

  .timer{display:grid;place-items:center;height:80px;background:#0e1330;border:1px solid #2b3155;border-radius:12px;font-weight:800;letter-spacing:.5px;font-size:28px}

  .fx-overlay{position:fixed;inset:0;display:grid;place-items:center;pointer-events:none;opacity:0;transition:opacity .25s ease;z-index:999}
  .fx-overlay.show{opacity:1}
  .fx-overlay img{max-width:min(60vmin,520px);max-height:70vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.55);border:2px solid #2b3155}

  /* Turn overlay (between players) */
  .turn-overlay{position:fixed;inset:0;background:rgba(5,8,20,.88);backdrop-filter:blur(6px);display:grid;place-items:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .2s ease}
  .turn-overlay.show{opacity:1;pointer-events:auto}
  .turn-card{background:var(--panel);border:1px solid #2b3155;border-radius:18px;padding:28px;display:grid;gap:14px;place-items:center;box-shadow:0 20px 60px rgba(0,0,0,.45)}
  .turn-card h2{margin:0;font-size:clamp(20px,3.2vw,28px)}
  .turn-avatar{width:min(22vmin,140px);height:min(22vmin,140px);border-radius:50%;object-fit:cover;border:2px solid #2b3155}

  footer{margin-top:14px;color:var(--muted);font-size:12px;display:flex;gap:12px;align-items:center}

  /* Responsive */
  @media (max-width:1200px){
    .controls{grid-template-columns:repeat(4,minmax(0,1fr));}
    .group.names{grid-column:1 / -1;}
    .names-row{grid-template-columns:1fr}
  }
  @media (max-width:860px){
    .controls{grid-template-columns:1fr 1fr}
    .grid{grid-template-columns:1fr}
  }
  @media (max-width:700px){
    .controls{grid-template-columns:1fr;}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Math Sprint</h1>
      <div style="display:flex;gap:10px">
        <button id="btnStart" class="btn good">Start ▶</button>
        <button id="btnReset" class="btn ghost">Reset ⟲</button>
      </div>
    </header>

    <section class="controls">
      <div class="group">
        <label>Mode</label>
        <select id="mode">
          <option value="add">Add (+)</option>
          <option value="sub">Subtract (−)</option>
          <option value="mul">Multiply (×)</option>
          <option value="div">Divide (÷)</option>
          <option value="mix" selected>Mix</option>
        </select>
      </div>
      <div class="group">
        <label>Difficulty (1–10)</label>
        <div class="range-row">
          <input id="difficulty" type="range" min="1" max="10" value="3" />
          <span id="diffVal" class="chip">3</span>
        </div>
      </div>
      <div class="group">
        <label>Timer / Q (0=off)</label>
        <div class="range-row">
          <input id="timerSec" type="range" min="0" max="60" value="10" />
          <span id="timerVal" class="chip">10s</span>
        </div>
      </div>
      <div class="group">
        <label>Rounds per player</label>
        <select id="rounds"><option>5</option><option selected>10</option><option>15</option><option>20</option></select>
      </div>
      <div class="group">
        <label>Players</label>
        <select id="players">
          <option value="1" selected>Single</option>
          <option value="2">Head-to-Head (2)</option>
        </select>
      </div>

      <!-- Music controls -->
      <div class="group">
        <label>Music</label>
        <div class="range-row">
          <select id="musicOn"><option value="1">On</option><option value="0" selected>Off</option></select>
          <span class="chip">Vol</span>
        </div>
        <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.35" />
      </div>

      <!-- Names + avatar previews -->
      <div class="group names">
        <label>Names</label>
        <div class="names-row">
          <div class="namebox">
            <img id="nameAvatarP1" class="name-avatar" alt="">
            <input id="nameP1" type="text" placeholder="Player 1" value="Player 1" />
          </div>
          <div class="namebox">
            <img id="nameAvatarP2" class="name-avatar" alt="">
            <input id="nameP2" type="text" placeholder="Player 2" value="Player 2" />
          </div>
        </div>
      </div>

      <div class="group">
        <label>Sound FX</label>
        <div class="range-row">
          <select id="soundOn"><option value="1" selected>On</option><option value="0">Off</option></select>
          <span class="chip">Vol</span>
        </div>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.5" />
      </div>

      <div class="group">
        <label>&nbsp;</label>
        <span class="chip">Start turn: Space/Enter • P1/P2 submit: Enter • Skip: S</span>
      </div>
    </section>

    <section class="grid" style="margin-top:16px">
      <div class="card">
        <div class="problem" id="problem">
          <div class="turn" id="turnBanner">—</div>
          <div id="formula" class="formula">—</div>

          <!-- single player row -->
          <div id="singleRows" class="answer-rows" style="display:grid">
            <div class="row">
              <img id="soloAvatar" class="avatar hidden" alt="">
              <input id="answer1" class="p1" type="text" inputmode="numeric" placeholder="Your answer…" disabled />
              <button id="btnSubmit1" class="btn">Submit ⏎</button>
            </div>
          </div>

          <!-- multiplayer rows (only active row shown) -->
          <div id="multiRows" class="answer-rows" style="display:none">
            <div class="row" id="rowP1">
              <img id="avatarP1" class="avatar" alt="">
              <input id="answerP1" class="p1" type="text" inputmode="numeric" placeholder="P1…" disabled />
              <button id="btnSubmitP1" class="btn">Submit</button>
            </div>
            <div class="row" id="rowP2">
              <img id="avatarP2" class="avatar" alt="">
              <input id="answerP2" class="p2" type="text" inputmode="numeric" placeholder="P2…" disabled />
              <button id="btnSubmitP2" class="btn">Submit</button>
            </div>
          </div>

          <div id="feedback" class="feedback">&nbsp;</div>
        </div>

        <!-- stats -->
        <div class="stats">
          <div class="stat"><label>Total Correct</label><b id="statGood">0</b></div>
          <div class="stat"><label>Total Incorrect</label><b id="statBad">0</b></div>
          <div class="stat"><label>Accuracy</label><b id="statAcc">—</b></div>
        </div>
        <div id="versus" class="stats" style="display:none">
          <div class="stat"><label id="lblP1">P1 ✓ / ✗</label><b id="p1Score">0 / 0</b></div>
          <div class="stat"><label id="lblP2">P2 ✓ / ✗</label><b id="p2Score">0 / 0</b></div>
          <div class="stat"><label>Lead</label><b id="lead">—</b></div>
        </div>

        <footer>Shortcuts: Start turn (Space/Enter) • Submit (Enter) • Esc clear • S skip</footer>
      </div>

      <div class="card">
        <div class="timer" id="timer">Timer: off</div>
        <div class="stat" style="margin-top:12px"><label>Question</label><b id="qIndex">0</b></div>
        <div class="stat" style="margin-top:8px"><label>Streak</label><b id="streak">0</b></div>
        <div class="stat" style="margin-top:8px"><label>Best streak</label><b id="bestStreak">0</b></div>
        <div class="stat" style="margin-top:8px"><label>Last result</label><b id="lastResult">—</b></div>
      </div>
    </section>
  </div>

  <!-- overlays -->
  <div id="fxGood" class="fx-overlay"><img id="fxGoodImg" alt="Correct"></div>
  <div id="fxBad"  class="fx-overlay"><img id="fxBadImg"  alt="Incorrect"></div>

  <!-- Turn overlay -->
  <div id="turnOverlay" class="turn-overlay">
    <div class="turn-card">
      <img id="turnAvatar" class="turn-avatar" alt="">
      <h2 id="turnText">Next up: —</h2>
      <button id="btnBeginTurn" class="btn good">Start turn ▶</button>
      <div class="chip">or press Space / Enter</div>
    </div>
  </div>

  <!-- Background music element (file optional) -->
  <audio id="bgm" src="audio/bgm.mp3" loop preload="auto"></audio>

<script>
(() => {
  // ------- DOM -------
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const elMode=$('#mode'), elDiff=$('#difficulty'), elDiffVal=$('#diffVal');
  const elTimerSec=$('#timerSec'), elTimerVal=$('#timerVal');
  const elRounds=$('#rounds'), elPlayers=$('#players');
  const elNameP1=$('#nameP1'), elNameP2=$('#nameP2');

  // music + sfx
  const elMusicOn=$('#musicOn'), elMusicVol=$('#musicVol'), BGM=$('#bgm');
  const elSoundOn=$('#soundOn'), elVol=$('#volume');

  const elStart=$('#btnStart'), elReset=$('#btnReset');
  const elSingle=$('#singleRows'), elMulti=$('#multiRows');
  const elAns1=$('#answer1'), elBtn1=$('#btnSubmit1');
  const elP1=$('#answerP1'), elP2=$('#answerP2');
  const elBtnP1=$('#btnSubmitP1'), elBtnP2=$('#btnSubmitP2');
  const rowP1=$('#rowP1'), rowP2=$('#rowP2');
  const avatarP1=$('#avatarP1'), avatarP2=$('#avatarP2'), soloAvatar=$('#soloAvatar');
  const nameAvatarP1=$('#nameAvatarP1'), nameAvatarP2=$('#nameAvatarP2');

  const elFormula=$('#formula'), elFeedback=$('#feedback');
  const elStatGood=$('#statGood'), elStatBad=$('#statBad'), elStatAcc=$('#statAcc');
  const elQIndex=$('#qIndex'), elTimer=$('#timer'), elStreak=$('#streak'), elBest=$('#bestStreak'), elLast=$('#lastResult');
  const elVersus=$('#versus'), elP1Score=$('#p1Score'), elP2Score=$('#p2Score'), elLead=$('#lead');
  const elLblP1=$('#lblP1'), elLblP2=$('#lblP2');
  const elTurn=$('#turnBanner');

  const fxGood=$('#fxGood'), fxBad=$('#fxBad'), fxGoodImg=$('#fxGoodImg'), fxBadImg=$('#fxBadImg');

  // Turn overlay
  const overlay=$('#turnOverlay'), overlayText=$('#turnText'), overlayAvatar=$('#turnAvatar'), btnBeginTurn=$('#btnBeginTurn');

  // ------- State -------
  const GOOD_IMGS=["images/correct1.webp","images/correct2.webp"];
  const BAD_IMGS =["images/wrong1.webp"];
  const TRY_P1=["images/players/p1.webp","images/players/p1.png","images/players/p1.jpg"];
  const TRY_P2=["images/players/p2.webp","images/players/p2.png","images/players/p2.jpg"];

  let P1_IMG=null, P2_IMG=null;

  let running=false, current=null, qCount=0;
  let good=0,bad=0,streak=0,bestStreak=0;
  let p1={ok:0,no:0,played:0}, p2={ok:0,no:0,played:0};
  let tick=null, remaining=0;
  let turn='p1';
  let awaitingTurnStart=false;

  // ------- find first existing image among candidates -------
  function pickFirstAvailable(candidates, cb){
    let i=0;
    function tryNext(){
      if(i>=candidates.length){ cb(null); return; }
      const src=candidates[i++], img=new Image();
      img.onload=()=>cb(src);
      img.onerror=tryNext;
      img.src=src;
    }
    tryNext();
  }
  function setAvatar(imgEl, src){ if(!src){ imgEl.classList.add('hidden'); return; } imgEl.src=src; imgEl.classList.remove('hidden'); }

  pickFirstAvailable(TRY_P1, src=>{ P1_IMG=src; [avatarP1,nameAvatarP1,soloAvatar].forEach(el=>setAvatar(el,src)); });
  pickFirstAvailable(TRY_P2, src=>{ P2_IMG=src; [avatarP2,nameAvatarP2].forEach(el=>setAvatar(el,src)); });

  // ------- Music -------
  function updateMusic(){
    BGM.volume=+elMusicVol.value;
    if(elMusicOn.value==="1"){
      BGM.play().catch(()=>{/* overlay start will also trigger play */});
    }else{
      BGM.pause(); BGM.currentTime=0;
    }
  }
  elMusicOn.addEventListener('change',updateMusic);
  elMusicVol.addEventListener('input',updateMusic);

  // ------- Sound FX (WebAudio) -------
  const AC=new (window.AudioContext||window.webkitAudioContext)();
  const master=AC.createGain(); master.connect(AC.destination); master.gain.value=+elVol.value;
  const soundOn=()=>elSoundOn.value==="1";
  elVol.addEventListener('input',()=>master.gain.value=+elVol.value);
  function tone(freq,dur=0.12,type='sine',when=0,vol=0.3){
    if(!soundOn()) return;
    const o=AC.createOscillator(), g=AC.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master);
    const t=AC.currentTime+when; o.start(t);
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.stop(t+dur+0.02);
  }
  const sfx={ correct(){[523,659,784].forEach((f,i)=>tone(f,0.10,'triangle',i*0.08,0.25));},
              wrong(){tone(200,0.25,'sawtooth',0,0.35);tone(140,0.22,'sawtooth',0.04,0.28);},
              tick(){tone(900,0.03,'square',0,0.12);},
              timeout(){[523,392,330].forEach((f,i)=>tone(f,0.12,'sine',i*0.09,0.22));}};

  // ------- Math -------
  const clamp=(n,a,b)=>Math.min(Math.max(n,a),b);
  const rnd=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const pickOp=m=>m!=='mix'?m:['add','sub','mul','div'][rnd(0,3)];
  function rangeFor(op,L){
    L=clamp(+L,1,10);
    const add=[9,12,20,30,40,60,90,120,180,250][L-1];
    const mul=[5,6,8,9,10,12,15,18,20,25][L-1];
    if(op==='mul') return {min:0,max:mul};
    if(op==='div') return {min:1,max:mul};
    return {min:0,max:add};
  }
  const ops={
    add:{gen:L=>{const r=rangeFor('add',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:`${a} + ${b}`,answer:a+b}}},
    sub:{gen:L=>{const r=rangeFor('sub',L);let a=rnd(r.min,r.max),b=rnd(r.min,r.max);if(b>a)[a,b]=[b,a];return {text:`${a} − ${b}`,answer:a-b}}},
    mul:{gen:L=>{const r=rangeFor('mul',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:`${a} × ${b}`,answer:a*b}}},
    div:{gen:L=>{const r=rangeFor('div',L),b=rnd(r.min,r.max),q=rnd(r.min,r.max),a=b*q;return {text:`${a} ÷ ${b}`,answer:q}}}
  };

  // ------- Helpers -------
  function flash(el,list,hold=600){
    const pick=list[rnd(0,list.length-1)];
    (el===fxGood?fxGoodImg:fxBadImg).src=pick;
    el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),hold);
  }
  function activeName(){ return turn==='p1' ? (elNameP1.value||'Player 1') : (elNameP2.value||'Player 2'); }
  function updateTurnBanner(){ elTurn.textContent = elPlayers.value==='2' ? `Turn: ${activeName()}` : '—'; }
  function setRowVis(){
    const p1Active = (turn==='p1');
    rowP1.classList.toggle('hidden',!p1Active);
    rowP2.classList.toggle('hidden', p1Active);
    elP1.disabled=!p1Active; elP2.disabled=p1Active;
    (p1Active?elP1:elP2).focus();
  }

  // ------- UI mode -------
  function uiMode(){
    const two=elPlayers.value==="2";
    $('#answerP1').placeholder = elNameP1.value||'Player 1';
    $('#answerP2').placeholder = elNameP2.value||'Player 2';
    elLblP1.textContent=(elNameP1.value||'Player 1')+' ✓ / ✗';
    elLblP2.textContent=(elNameP2.value||'Player 2')+' ✓ / ✗';
    elVersus.style.display = two ? 'grid' : 'none';
    elSingle.style.display = two ? 'none' : 'grid';
    elMulti.style.display  = two ? 'grid' : 'none';
    updateTurnBanner();
    if(two) setRowVis();
  }
  elPlayers.addEventListener('change',uiMode);
  elNameP1.addEventListener('input',uiMode);
  elNameP2.addEventListener('input',uiMode);

  // ------- Turn overlay (hand-off) -------
  let awaitingTurnStart=false;
  function showTurnOverlay(){
    if(elPlayers.value!=='2') return;
    overlayText.textContent = `Next up: ${activeName()}`;
    overlayAvatar.src = (turn==='p1' ? (P1_IMG||'') : (P2_IMG||''));
    if(!overlayAvatar.src) overlayAvatar.classList.add('hidden'); else overlayAvatar.classList.remove('hidden');
    overlay.classList.add('show');
    awaitingTurnStart = true;
  }
  function hideTurnOverlay(){
    overlay.classList.remove('show');
    awaitingTurnStart = false;
    if(elMusicOn.value==="1"){ BGM.play().catch(()=>{}); } // gesture satisfied
  }
  $('#btnBeginTurn').addEventListener('click',()=>{
    hideTurnOverlay();
    setRowVis();
    next(true); // first question of this turn
  });
  window.addEventListener('keydown',e=>{
    if(awaitingTurnStart && (e.key===' ' || e.key==='Enter')){ e.preventDefault(); $('#btnBeginTurn').click(); }
  });

  // ------- Core flow -------
  let everyonePlayed = () => (p1.played>=parseInt(elRounds.value,10) && p2.played>=parseInt(elRounds.value,10));
  function start(){
    if(running) return;
    AC.resume?.(); updateMusic();
    running=true; qCount=0; good=bad=0; streak=bestStreak=0;
    p1={ok:0,no:0,played:0}; p2={ok:0,no:0,played:0};
    elStart.textContent='Running…'; elStart.disabled=true;

    turn = Math.random()<0.5 ? 'p1' : 'p2';
    setRowVis(); updateTurnBanner();
    showTurnOverlay(); // wait for start
  }
  function reset(){
    stopTimer(); running=false; current=null; qCount=good=bad=streak=bestStreak=0;
    p1={ok:0,no:0,played:0}; p2={ok:0,no:0,played:0};
    elStart.textContent='Start ▶'; elStart.disabled=false;
    [elAns1,elP1,elP2].forEach(i=>{i.value=''; i.disabled=true;});
    elFormula.textContent='—'; elFeedback.textContent=' '; elFeedback.className='feedback'; elTimer.textContent='Timer: off';
    elP1Score.textContent='0 / 0'; elP2Score.textContent='0 / 0'; elLead.textContent='—';
    overlay.classList.remove('show'); awaitingTurnStart=false; BGM.pause();
    updateStats(); updateTurnBanner();
    elSingle.style.display='grid'; elMulti.style.display='none';
  }

  function sessionFinishedFor(id){ return (id==='p1'?p1:p2).played >= parseInt(elRounds.value,10); }

  function next(initial=false){
    if(awaitingTurnStart) return;
    stopTimer();

    if(elPlayers.value==='2' && !initial){
      if(sessionFinishedFor(turn)){
        if(everyonePlayed()) return finish();
        turn = (turn==='p1') ? 'p2' : 'p1';
        updateTurnBanner();
        showTurnOverlay(); // pause here until user starts next turn
        return;
      }
    }

    qCount++;
    const mode=pickOp(elMode.value), L=+elDiff.value;
    current=ops[mode].gen(L);
    elFormula.textContent=current.text+' = ?';
    elQIndex.textContent=qCount;
    [elAns1,elP1,elP2].forEach(i=>i.value='');
    elFeedback.textContent=' '; elFeedback.className='feedback';
    startTimerIfNeeded();
  }

  function finish(){
    stopTimer(); running=false; elStart.textContent='Start ▶'; elStart.disabled=false;
    const acc=accuracy();
    let verdict='Session complete — ';
    if(elPlayers.value==='2'){
      const p1Score=p1.ok, p2Score=p2.ok;
      if(p1Score>p2Score) verdict+=`${elNameP1.value||'Player 1'} wins!`;
      else if(p2Score>p1Score) verdict+=`${elNameP2.value||'Player 2'} wins!`;
      else {
        const t1=p1.no,t2=p2.no;
        verdict+=(t1<t2?`${elNameP1.value||'Player 1'} wins by fewer mistakes!`:
                  t2<t1?`${elNameP2.value||'Player 2'} wins by fewer mistakes!`:'It’s a tie!');
      }
      verdict+=`  (${elNameP1.value||'P1'} ${p1.ok}/${p1.no} vs ${elNameP2.value||'P2'} ${p2.ok}/${p2.no})`;
    } else {
      verdict+=`${good} correct, ${bad} wrong, accuracy ${acc==='—'?'—':acc}%`;
    }
    elFeedback.textContent=verdict;
    elFeedback.className='feedback ' + (good>=bad ? 'ok':'no');
  }

  // ------- Answer submit -------
  function consumeRound(){ if(elPlayers.value==='2'){ (turn==='p1'?p1:p2).played++; } }
  function handleSubmit(val, who){
    if(awaitingTurnStart) return;
    if(!running||!current||val==='') return;
    const num=Number(val), correct=(num===current.answer);
    if(correct){
      good++; streak++; bestStreak=Math.max(bestStreak,streak);
      if(who==='p1'){ p1.ok++; elP1Score.textContent=`${p1.ok} / ${p1.no}`; elLead.textContent=leadText(); }
      if(who==='p2'){ p2.ok++; elP2Score.textContent=`${p2.ok} / ${p2.no}`; elLead.textContent=leadText(); }
      elFeedback.textContent=(who==='solo'?'Correct!':(activeName()+' scores!')); elFeedback.className='feedback ok';
      elLast.textContent='✓'; elLast.style.color='var(--good)';
      sfx.correct(); flash(fxGood,GOOD_IMGS,500);
      consumeRound(); setTimeout(()=>next(),180);
    } else {
      bad++; streak=0;
      if(who==='p1'){ p1.no++; elP1Score.textContent=`${p1.ok} / ${p1.no}`; }
      if(who==='p2'){ p2.no++; elP2Score.textContent=`${p2.ok} / ${p2.no}`; }
      elFeedback.textContent='Try again'; elFeedback.className='feedback no';
      elLast.textContent='✗'; elLast.style.color='var(--bad)';
      sfx.wrong(); flash(fxBad,BAD_IMGS,700);
    }
    updateStats();
  }
  function leadText(){ const d=p1.ok-p2.ok; return d===0?'Tied':(d>0?`${elNameP1.value||'P1'} +${d}`:`${elNameP2.value||'P2'} +${-d}`); }
  function skip(){
    if(awaitingTurnStart||!running) return;
    bad++; streak=0; elLast.textContent='⏭'; elLast.style.color='var(--warn)'; updateStats();
    flash(fxBad,BAD_IMGS,700);
    consumeRound(); next();
  }

  // ------- Timer -------
  function startTimerIfNeeded(){
    const sec=+elTimerSec.value;
    if(!sec){ elTimer.textContent='Timer: off'; return; }
    remaining=sec; renderTimer(); stopTimer();
    tick=setInterval(()=>{
      remaining--;
      if(remaining>0){ sfx.tick(); renderTimer(); return; }
      bad++; streak=0; updateStats();
      elFeedback.textContent='Time out — next!'; elFeedback.className='feedback no';
      elLast.textContent='⏲'; elLast.style.color='var(--bad)';
      sfx.timeout(); flash(fxBad,BAD_IMGS,700);
      consumeRound(); next();
    },1000);
  }
  function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }
  function renderTimer(){
    const warn=remaining<=Math.max(3,Math.floor(+elTimerSec.value*0.25));
    elTimer.textContent=`⏱ ${remaining}s`; elTimer.style.color=warn?'var(--warn)':'var(--ink)';
  }

  // ------- Stats -------
  function accuracy(){ const t=good+bad; return !t?'—':Math.round((good/t)*100); }
  function updateStats(){
    elStatGood.textContent=good; elStatBad.textContent=bad;
    const acc=accuracy(); elStatAcc.textContent=acc==='—'?'—':`${acc}%`;
    elStreak.textContent=streak; elBest.textContent=bestStreak;
  }

  // ------- Events -------
  elDiff.addEventListener('input',()=>elDiffVal.textContent=elDiff.value);
  elTimerSec.addEventListener('input',()=>elTimerVal.textContent=`${elTimerSec.value}s`);
  elStart.addEventListener('click',start); elReset.addEventListener('click',reset);

  elBtn1.addEventListener('click',()=>handleSubmit(elAns1.value.trim(),'solo'));
  elBtnP1.addEventListener('click',()=>turn==='p1'&&handleSubmit(elP1.value.trim(),'p1'));
  elBtnP2.addEventListener('click',()=>turn==='p2'&&handleSubmit(elP2.value.trim(),'p2'));

  elAns1.addEventListener('keydown',e=>{ if(e.key==='Enter')handleSubmit(elAns1.value.trim(),'solo'); if(e.key==='Escape')elAns1.value=''; });
  elP1  .addEventListener('keydown',e=>{ if(e.key==='Enter'&&turn==='p1')handleSubmit(elP1.value.trim(),'p1'); if(e.key==='Escape')elP1.value=''; });
  elP2  .addEventListener('keydown',e=>{ if(e.key==='Enter'&&turn==='p2')handleSubmit(elP2.value.trim(),'p2'); if(e.key==='Escape')elP2.value=''; });
  window.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='s') skip(); });

  // numeric-only inputs
  [elAns1,elP1,elP2].forEach(inp=>{
    inp.addEventListener('input',()=>inp.value=inp.value.replace(/[^\d-]/g,'').replace(/(?!^)-/g,''));
  });

  // preload result overlays
  fxGoodImg.src=GOOD_IMGS[0]; fxBadImg.src=BAD_IMGS[0];

  // init
  reset(); uiMode();
})();
</script>
</body>
</html>
