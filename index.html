<script>
(function(){
  // ===== Constants =====
  const NAME_P1 = 'Aliah';
  const NAME_P2 = 'Aliana';
  const STILL_MIN_MS = 1600;
  const HARD_OVERLAY_MS = 6500; // absolute safety cap for overlays

  // Music
  const MUSIC_TRACKS = [
    "Confused and Angry Robots.mp3",
    "Delightful Stroll.mp3",
    "Forest Theme - D Minor - Jordan Ottesen.mp3",
    "Rainbow Lollipop.mp3",
    "Space Knights.mp3",
    "Water Theme - G Major - Jordan Ottesen.mp3"
  ];

  // ===== DOM =====
  const $=s=>document.querySelector(s);
  const elMode=$('#mode'), elDiff=$('#difficulty'), elDiffVal=$('#diffVal');
  const elTimerSec=$('#timerSec'), elTimerVal=$('#timerVal');
  const elRounds=$('#rounds'), elPlayers=$('#players');

  const elMusicOn=$('#musicOn'), elMusicVol=$('#musicVol'), BGM=$('#bgm');
  const elSoundOn=$('#soundOn'), elVol=$('#volume'),
        SND_OK=$('#sndCorrect'), SND_NO=$('#sndWrong'), SND_FINISH=$('#sndFinish'),
        SND_START=$('#sndStart'), SND_SINGLE=$('#sndSingle'), SND_HEAD=$('#sndHead');

  const elStart=$('#btnStart'), elReset=$('#btnReset');
  const elSingle=$('#singleRows'), elMulti=$('#multiRows');
  const elAns1=$('#answer1'), elBtn1=$('#btnSubmit1');
  const elP1=$('#answerP1'), elP2=$('#answerP2');
  const elBtnP1=$('#btnSubmitP1'), elBtnP2=$('#btnSubmitP2');
  const rowP1=$('#rowP1'), rowP2=$('#rowP2');

  const elFormula=$('#formula'), elFeedback=$('#feedback');
  const elQIndex=$('#qIndex'), elTimer=$('#timerMini');
  const elVersus=$('#versus'), elP1Score=$('#p1Score'), elP2Score=$('#p2Score'), elLead=$('#lead');
  const elLblP1=$('#lblP1'), elLblP2=$('#lblP2'), elTurn=$('#turnBanner');

  const elStreak=$('#streak');

  const fxGood=$('#fxGood'), fxBad=$('#fxBad'),
        fxGoodImg=$('#fxGoodImg'), fxBadImg=$('#fxBadImg'),
        fxGoodVid=$('#fxGoodVid'), fxBadVid=$('#fxBadVid');

  const overlay=$('#turnOverlay'), overlayText=$('#turnText'), overlayAvatar=$('#turnAvatar'), btnBeginTurn=$('#btnBeginTurn');

  const finalOv = $('#finalOverlay'), finalScore = $('#finalScore'), finalClose = $('#finalClose');

  // ===== State =====
  const GOOD_IMAGES=[
    "images/Correct1.webp","images/Correct2.webp","images/Correct4.png","images/Correct5.png","images/Correct6.png",
    "images/Correct7.png","images/Correct8.png","images/Correct9.png","images/Correct10.png",
    "images/KpopRight1.mp4","images/KpopRight3.mp4","images/KpopRight4.mp4","images/KpopRight5.mp4","images/KpopRight6.mp4","images/KpopRight8.mp4"
  ];
  const BAD_IMAGES =[
    "images/Wrong1.png","images/Wrong2.png","images/Wrong3.png","images/Wrong4.jpg","images/Wrong5.webp","images/Wrong6.png","images/Wrong7.png",
    "images/KpopWrong1.mp4","images/KpopWrong2.mp4","images/KpopWrong3.mp4","images/KpopWrong4.mp4"
  ];
  const GOOD_VIDEOS=[]; const BAD_VIDEOS =[];
  const GOOD_POOL = GOOD_IMAGES.concat(GOOD_VIDEOS);
  const BAD_POOL  = BAD_IMAGES .concat(BAD_VIDEOS);

  let running=false, current=null, qCount=0;
  let good=0,bad=0;
  let p1={ok:0,no:0,played:0}, p2={ok:0,no:0,played:0};
  let tick=null, remaining=0, turn='p1', awaitingTurnStart=false;

  // overlay guard + streaks + submit guard
  let awaitingOverlay=false;
  let streakSolo=0, streakP1=0, streakP2=0;

  const P1_IMG="players/p1.png";
  const P2_IMG="players/p2.png";

  // ===== Music =====
  function setRandomBgm(){
    if (!MUSIC_TRACKS.length) return;
    const pick = MUSIC_TRACKS[Math.floor(Math.random()*MUSIC_TRACKS.length)];
    BGM.src = "sounds/" + pick;
  }
  function attemptAutoplay(){
    BGM.volume = +elMusicVol.value;
    BGM.play().catch(() => {
      const resume = () => {
        if (AC && AC.state === 'suspended') AC.resume();
        BGM.play().catch(()=>{});
        document.removeEventListener('pointerdown', resume);
        document.removeEventListener('keydown', resume);
      };
      document.addEventListener('pointerdown', resume, { once:true });
      document.addEventListener('keydown',   resume, { once:true });
    });
  }
  function updateMusic(){
    BGM.volume=+elMusicVol.value;
    if(elMusicOn.value==="1"){ BGM.play().catch(()=>{}); }
    else{ BGM.pause(); }
  }
  elMusicOn.addEventListener('change',updateMusic);
  elMusicVol.addEventListener('input',updateMusic);

  // ===== Sound FX =====
  const AC=(window.AudioContext||window.webkitAudioContext)? new (window.AudioContext||window.webkitAudioContext)() : null;
  const master=AC? AC.createGain():null; if(master){ master.connect(AC.destination); master.gain.value=+elVol.value; }
  function soundOn(){ return elSoundOn.value==="1"; }
  elVol.addEventListener('input',()=>{ if(master) master.gain.value=+elVol.value; });
  function tone(freq,dur,type,when,vol){
    if(!soundOn() || !AC) return;
    dur = dur||0.12; type=type||'sine'; when=when||0; vol=vol||0.2;
    const o=AC.createOscillator(), g=AC.createGain();
    o.type=type; o.frequency.value=freq; o.connect(g); g.connect(master);
    const t=AC.currentTime+when; o.start(t);
    g.gain.setValueAtTime(0.0001,t);
    g.gain.exponentialRampToValueAtTime(vol,t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
    o.stop(t+dur+0.02);
  }
  function playAudio(el){
    if(!soundOn() || !el) return;
    try{ el.currentTime=0; el.volume=+elVol.value; el.play(); }catch(e){}
  }
  const sfx={
    correct:()=>playAudio(SND_OK),
    wrong:()=>playAudio(SND_NO),
    tick:()=>tone(900,0.03,'square',0,0.12),
    timeout:()=>[523,392,330].forEach((f,i)=>tone(f,0.12,'sine',i*0.09,0.22))
  };

  // ===== Ducking (mute music + fx during MP4) =====
  const DUCK_MS = 0.08; // seconds for quick ramp
  let duckDepth = 0;
  function beginDucking(){
    duckDepth++;
    try{ BGM.muted = true; }catch(e){}
    if(master && AC){
      const now = AC.currentTime;
      master.gain.cancelScheduledValues(now);
      master.gain.setTargetAtTime(0.0001, now, DUCK_MS);
    }
  }
  function endDucking(){
    duckDepth = Math.max(0, duckDepth-1);
    if(duckDepth>0) return;
    try{ BGM.muted = false; BGM.volume = +elMusicVol.value; }catch(e){}
    if(master && AC){
      const now = AC.currentTime;
      master.gain.cancelScheduledValues(now);
      master.gain.setTargetAtTime(+elVol.value || 0, now, DUCK_MS);
    }
  }

  // ===== Media helpers (HARDENED) =====
  const BLANK_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";
  const isGif   = src => /\.gif(?:$|\?)/i.test(src);
  const isVideo = src => /\.(mp4)(?:$|\?)/i.test(src);

  function gifHoldFromName(src){
    let m = src && src.match ? src.match(/[?&]dur=(\d+)/i) : null;
    if (m) return +m[1];
    m = src && src.match ? src.match(/@(\d+(?:\.\d+)?)(ms|s)\.gif(?:$|\?)/i) : null;
    if (m) return m[2].toLowerCase()==='s' ? Math.round(+m[1]*1000) : Math.round(+m[1]);
    return null;
  }
  async function computeGifDurationMs(url){
    try{
      const res = await fetch(url, {cache:'force-cache'});
      const buf = await res.arrayBuffer();
      const dv = new DataView(buf);
      const len = dv.byteLength;
      let totalCs = 0;
      for (let i=0; i < len - 9; i++){
        if (dv.getUint8(i)===0x21 && dv.getUint8(i+1)===0xF9 && dv.getUint8(i+2)===0x04){
          let delayCs = dv.getUint16(i+4, true);
          if (delayCs < 3) delayCs = 10;
          totalCs += delayCs;
          i += 7;
        }
      }
      if (totalCs === 0) return 2500;
      return totalCs * 10;
    }catch(e){ return 2500; }
  }

  function pickIndexAvoidRepeat(len, last){
    if (len<=1) return 0;
    let idx = Math.floor(Math.random()*len);
    if (idx===last) idx = (idx+1) % len;
    return idx;
  }

  function scheduleHide(el, ms, onDone){
    if (el._hideTimer) clearTimeout(el._hideTimer);
    el._hideTimer = setTimeout(()=>{
      el.classList.remove('show');
      el._hideTimer=null;
      if (typeof onDone === 'function') onDone();
    }, ms);
  }

  function flashAsync(el, pool, hold){
    hold = hold || 600;
    return new Promise(resolve=>{
      const isGood = (el === fxGood);
      const imgEl  = isGood ? fxGoodImg : fxBadImg;
      const vidEl  = isGood ? fxGoodVid : fxBadVid;

      // SAFETY: hard cap so we never hang
      let safety = setTimeout(()=>{ cleanup(); endDucking(); el.classList.remove('show'); resolve(); }, Math.max(hold, HARD_OVERLAY_MS));
      const clearSafety = ()=>{ if(safety){ clearTimeout(safety); safety=null; } };

      const cleanup = ()=>{
        // remove listeners and stop media
        vidEl.onloadedmetadata = null;
        vidEl.removeEventListener('ended', onEnded);
        vidEl.removeEventListener('error', onEnded);
        vidEl.removeEventListener('stalled', onEnded);
        vidEl.removeEventListener('abort', onEnded);
        try{ vidEl.pause(); }catch(e){}
        try{ vidEl.removeAttribute('src'); vidEl.load?.(); }catch(e){}
        if (vidEl._fallbackTimer){ clearTimeout(vidEl._fallbackTimer); vidEl._fallbackTimer=null; }
        if (el._errAttempts) el._errAttempts=0;
        if (el._imgTimer){ clearTimeout(el._imgTimer); el._imgTimer=null; }
      };

      const onEnded = ()=>{
        cleanup();
        clearSafety();
        endDucking();
        el.classList.remove('show');
        resolve();
      };

      try{ vidEl.pause(); }catch(e){}
      vidEl.removeAttribute('src');
      vidEl.load?.();

      const lastKey = isGood ? '_lastGood' : '_lastBad';
      const poolArr = (pool && pool.length) ? pool.filter(Boolean) : [BLANK_IMG];
      const idx = pickIndexAvoidRepeat(poolArr.length, el[lastKey] ?? -1);
      el[lastKey] = idx;
      const pick = poolArr[idx];

      el.classList.add('show');
      imgEl.onerror = null;

      if (isVideo(pick)){
        imgEl.style.display='none';
        vidEl.style.display='block';
        vidEl.volume = 1;

        beginDucking();

        vidEl.addEventListener('ended', onEnded);
        // NEW: error/stall fallbacks
        vidEl.addEventListener('error', onEnded);
        vidEl.addEventListener('stalled', onEnded);
        vidEl.addEventListener('abort', onEnded);

        vidEl.onloadedmetadata = ()=>{
          const ms = Math.max(hold, ((vidEl.duration||0)*1000|0)+150);
          vidEl._fallbackTimer = setTimeout(()=>{ onEnded(); }, ms+80);
        };

        try{
          vidEl.src = pick;
          const p = vidEl.play();
          if (p && typeof p.then === 'function'){
            p.catch(()=>{ scheduleHide(el, Math.max(hold, 4000), ()=>{ onEnded(); }); });
          }
        }catch(e){
          scheduleHide(el, Math.max(hold, 4000), ()=>{ onEnded(); });
        }
        return;
      }

      // images/gifs
      vidEl.style.display='none';
      imgEl.style.display='block';

      imgEl.onerror = ()=>{
        let attempts = (el._errAttempts||0)+1;
        el._errAttempts = attempts;
        if (attempts<3){
          el[lastKey] = -1;
          el.classList.remove('show');
          clearSafety();
          resolve();
        }else{
          imgEl.src = BLANK_IMG;
          el._imgTimer = scheduleHide(el, STILL_MIN_MS, ()=>{ el._errAttempts=0; clearSafety(); resolve(); });
        }
      };
      imgEl.onload = ()=>{ el._errAttempts=0; };
      imgEl.src = pick || BLANK_IMG;

      if (!isGif(pick)) {
        scheduleHide(el, Math.max(hold, STILL_MIN_MS), ()=>{ clearSafety(); resolve(); });
        return;
      }

      const override = gifHoldFromName(pick);
      if (override != null){
        scheduleHide(el, Math.max(hold, override), ()=>{ clearSafety(); resolve(); });
        return;
      }
      computeGifDurationMs(pick).then(ms=>{
        scheduleHide(el, Math.max(hold, (ms||2500)+150), ()=>{ clearSafety(); resolve(); });
      }).catch(()=>{
        scheduleHide(el, Math.max(hold, 2500), ()=>{ clearSafety(); resolve(); });
      });
    });
  }

  // ===== Game helpers =====
  function clamp(n,a,b){return Math.min(Math.max(n,a),b);}
  function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
  function pickOp(m){return m!=='mix'?m:['add','sub','mul','div'][rnd(0,3)];}
  function rangeFor(op,L){
    L=clamp(+L,1,10);
    const add=[9,12,20,30,40,60,90,120,180,250][L-1];
    const mul=[5,6,8,9,10,12,15,18,20,25][L-1];
    if(op==='mul') return {min:0,max:mul};
    if(op==='div') return {min:1,max:mul};
    return {min:0,max:add};
  }
  const ops={
    add:{gen:L=>{const r=rangeFor('add',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:a+" + "+b,answer:a+b};}},
    sub:{gen:L=>{const r=rangeFor('sub',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);if(b>a){const t=a;a=b;b=t;}return {text:a+" − "+b,answer:a-b};}},
    mul:{gen:L=>{const r=rangeFor('mul',L),a=rnd(r.min,r.max),b=rnd(r.min,r.max);return {text:a+" × "+b,answer:a*b};}},
    div:{gen:L=>{const r=rangeFor('div',L),b=rnd(r.min,r.max),q=rnd(r.min,r.max),a=b*q;return {text:a+" ÷ "+b,answer:q};}}
  };

  function activeName(){ return turn==='p1' ? NAME_P1 : NAME_P2; }
  function currentStreak(){ return elPlayers.value==='2' ? (turn==='p1'?streakP1:streakP2) : streakSolo; }
  function setCurrentStreak(v){ if(elPlayers.value==='2'){ if(turn==='p1') streakP1=v; else streakP2=v; } else { streakSolo=v; } }
  function renderStreak(){ elStreak.textContent = String(currentStreak()); }

  function updateTurnBanner(){ elTurn.textContent = elPlayers.value==='2' ? ('Turn: '+activeName()) : '—'; }

  function setRowVis(){
    const two = elPlayers.value==="2";
    if(two){
      const p1Active = (turn==='p1');
      rowP1.classList.toggle('hidden',!p1Active);
      rowP2.classList.toggle('hidden', p1Active);
      elP1.disabled=!p1Active; elP2.disabled=p1Active;
      (p1Active?elP1:elP2).focus();
    }
  }

  function uiMode(){
    const two = elPlayers.value==="2";
    elSingle.style.display = two ? 'none':'grid';
    elMulti .style.display = two ? 'grid':'none';
    elVersus.style.display = two ? 'grid':'none';
    elLblP1.textContent= NAME_P1+' ✓ / ✗';
    elLblP2.textContent= NAME_P2+' ✓ / ✗';
    $('#answerP1').placeholder = NAME_P1;
    $('#answerP2').placeholder = NAME_P2;
    updateTurnBanner();
    renderStreak();
    if(two) setRowVis();
  }

  // freeze/unfreeze inputs (now aware of overlays)
  function freezeInputs(){ elAns1.disabled=true; elP1.disabled=true; elP2.disabled=true; }
  function unfreezeInputs(){
    if (awaitingOverlay || awaitingTurnStart) return;
    if(elPlayers.value==='1'){
      elAns1.disabled=false; elAns1.focus();
    }else{
      setRowVis();
    }
  }

  elPlayers.addEventListener('change', function(){
    if (elPlayers.value === "1") playAudio(SND_SINGLE);
    else if (elPlayers.value === "2") playAudio(SND_HEAD);
    uiMode();
  });

  function showTurnOverlay(){
    if(elPlayers.value!=='2') return;
    overlayText.textContent = 'Next up: ' + activeName();
    overlayAvatar.src = (turn==='p1')? P1_IMG : P2_IMG;
    overlayAvatar.onerror = ()=>{ overlayAvatar.style.display='none'; };
    overlayAvatar.onload  = ()=>{ overlayAvatar.style.display='block'; };
    overlay.classList.add('show');
    awaitingTurnStart = true;
    renderStreak();
    freezeInputs();
  }
  function hideTurnOverlay(){ overlay.classList.remove('show'); awaitingTurnStart=false; unfreezeInputs(); }

  btnBeginTurn.addEventListener('click', function(){
    hideTurnOverlay();
    setRandomBgm();
    attemptAutoplay();
    qCount = 0; elQIndex.textContent = '0';
    setRowVis();
    next(true);
  });
  window.addEventListener('keydown', function(e){
    if(awaitingTurnStart && (e.key===' ' || e.key==='Enter')){ e.preventDefault(); btnBeginTurn.click(); }
  });

  function everyonePlayed(){ const r=parseInt(elRounds.value,10); return (p1.played>=r && p2.played>=r); }
  function sessionFinishedFor(id){ const r=parseInt(elRounds.value,10); return (id==='p1'?p1:p2).played>=r; }

  function start(){
    if(running) return;
    if(AC && AC.state==='suspended'){ AC.resume(); }
    running=true; qCount=0; good=bad=0; p1={ok:0,no:0,played:0}; p2={ok:0,no:0,played:0};
    streakSolo=streakP1=streakP2=0; renderStreak();
    elStart.textContent='Running…'; elStart.disabled=true;

    playAudio(SND_START);
    setRandomBgm(); attemptAutoplay();

    if(elPlayers.value==="2"){
      turn = (Math.random()<0.5)?'p1':'p2';
      updateTurnBanner();
      qCount = 0; elQIndex.textContent = '0';
      showTurnOverlay();
    }else{
      elAns1.disabled=false; next(true); elAns1.focus();
    }
    uiMode();
  }

  function hardHideFX(){
    [fxGood, fxBad].forEach(el=>{
      el.classList.remove('show');
      const vid = el===fxGood ? fxGoodVid : fxBadVid;
      try{ vid.pause(); }catch(e){}
      try{ vid.removeAttribute('src'); vid.load?.(); }catch(e){}
      if (el._hideTimer) { clearTimeout(el._hideTimer); el._hideTimer=null; }
    });
    endDucking();
    awaitingOverlay=false;
  }

  function reset(){
    stopTimer(); running=false; current=null; qCount=good=bad=0; p1={ok:0,no:0,played:0}; p2={ok:0,no:0,played:0};
    streakSolo=streakP1=streakP2=0; renderStreak();
    elStart.textContent='Start ▶'; elStart.disabled=false;
    [elAns1,elP1,elP2].forEach(i=>{i.value=''; i.disabled=true;});
    elFormula.textContent='—'; elFeedback.textContent=' '; elFeedback.className='feedback'; elTimer.textContent='Timer: off';
    elP1Score.textContent='0 / 0'; elP2Score.textContent='0 / 0'; elLead.textContent='—';
    elQIndex.textContent='0';
    overlay.classList.remove('show'); awaitingTurnStart=false;
    hideFinal();
    hardHideFX();
  }

  function next(initial){
    if(awaitingTurnStart) return;
    stopTimer();

    if (elPlayers.value === '2') {
      if (!initial && sessionFinishedFor(turn)) {
        if (everyonePlayed()) return finish();
        turn = (turn === 'p1') ? 'p2' : 'p1';
        updateTurnBanner();
        showTurnOverlay();
        return;
      }
    } else {
      const maxQ = parseInt(elRounds.value, 10);
      if (!initial && qCount >= maxQ) return finish();
    }

    qCount++;
    const mode=pickOp(elMode.value), L=+elDiff.value;
    current=ops[mode].gen(L);
    current._done=false; // guard
    elFormula.textContent = current.text;
    elQIndex.textContent=qCount;
    [elAns1,elP1,elP2].forEach(i=>{i.value='';});
    elFeedback.textContent=' '; elFeedback.className='feedback';
    renderStreak();

    unfreezeInputs();
    startTimerIfNeeded();
  }

  function finish(){
    if (SND_FINISH) { try { SND_FINISH.currentTime = 0; SND_FINISH.play(); } catch(e){} }
    stopTimer(); running=false; elStart.textContent='Start ▶'; elStart.disabled=false;

    let scoreLine = '';
    if(elPlayers.value==='2'){
      const p1Score=p1.ok, p2Score=p2.ok;
      const n1=NAME_P1, n2=NAME_P2;
      let winner;
      if(p1Score>p2Score) winner = n1 + ' wins!';
      else if(p2Score>p1Score) winner = n2 + ' wins!';
      else {
        const t1=p1.no,t2=p2.no;
        winner = (t1<t2 ? (n1+' wins by fewer mistakes!') :
                 (t2<t1 ? (n2+' wins by fewer mistakes!') : 'It’s a tie!'));
      }
      scoreLine = winner + ' ('+n1+' '+p1.ok+'/'+p1.no+' vs '+n2+' '+p2.ok+'/'+p2.no+')';
    }else{
      const t = good + bad;
      const acc = t ? Math.round((good / t) * 100) : '—';
      scoreLine = good+' correct, '+bad+' wrong, accuracy '+(acc==='—'?'—':acc+'%');
    }
    elFeedback.textContent=' '; elFeedback.className='feedback'; showFinal(scoreLine);
    freezeInputs();
  }

  function showFinal(text){ finalScore.textContent=text; finalOv.classList.add('show'); finalOv.setAttribute('aria-hidden','false'); }
  function hideFinal(){ finalOv.classList.remove('show'); finalOv.setAttribute('aria-hidden','true'); }

  finalClose.addEventListener('click', hideFinal);
  finalOv.addEventListener('click', e=>{ if(e.target===finalOv) hideFinal(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') { if(finalOv.classList.contains('show')) hideFinal(); } });

  function consumeRound(){ if(elPlayers.value==='2'){ (turn==='p1'?p1:p2).played++; } }
  function leadText(){ const d=p1.ok-p2.ok; return d===0?'Tied':(d>0?(NAME_P1)+' +'+d:(NAME_P2)+' +'+(-d)); }

  async function afterOverlayThenNext(promise){
    try{
      awaitingOverlay=true;
      freezeInputs();
      // absolute timeout so we never hang on a bad media file
      const timed = Promise.race([
        promise,
        new Promise(res=>setTimeout(res, HARD_OVERLAY_MS+200))
      ]);
      await timed;
    }finally{
      awaitingOverlay=false;
      unfreezeInputs();
      try{ next(); }catch(e){ /* swallow to avoid breaking the loop */ }
    }
  }

  async function handleSubmit(val, who){
    if(awaitingTurnStart) return;
    if(!running || !current || val==='') return;

    // guard against double-submit on same question
    if (awaitingOverlay || current._done) return;
    current._done = true;
    freezeInputs();
    stopTimer();

    const num = Number(val);
    const correct = (num === current.answer);

    if (correct) {
      good++;
      setCurrentStreak(currentStreak()+1); renderStreak();

      if (who === 'p1'){ p1.ok++; elP1Score.textContent = p1.ok + ' / ' + p1.no; elLead.textContent = leadText(); }
      if (who === 'p2'){ p2.ok++; elP2Score.textContent = p2.ok + ' / ' + p2.no; elLead.textContent = leadText(); }
      elFeedback.textContent = (who==='solo' ? 'Correct!' : (activeName() + ' scores!'));
      elFeedback.className = 'feedback ok';
      sfx.correct();
      consumeRound();

      await afterOverlayThenNext(flashAsync(fxGood, GOOD_POOL, 400));
      return;
    }

    // wrong
    bad++;
    setCurrentStreak(0); renderStreak();

    if (who === 'p1'){ p1.no++; elP1Score.textContent = p1.ok + ' / ' + p1.no; elLead.textContent = leadText(); }
    if (who === 'p2'){ p2.no++; elP2Score.textContent = p2.ok + ' / ' + p2.no; elLead.textContent = leadText(); }
    elFeedback.textContent = '✗ Wrong';
    elFeedback.className = 'feedback no';
    sfx.wrong();
    consumeRound();

    await afterOverlayThenNext(flashAsync(fxBad, BAD_POOL, 450));
  }

  async function skip(){
    if(awaitingTurnStart || !running) return;
    if(awaitingOverlay || !current || current._done) return;
    current._done = true;
    freezeInputs();
    stopTimer();
    bad++;
    setCurrentStreak(0); renderStreak();
    elFeedback.textContent='⏭ Skipped';
    elFeedback.className='feedback no';
    consumeRound();
    await afterOverlayThenNext(flashAsync(fxBad, BAD_POOL, 300));
  }

  // Timer
  function startTimerIfNeeded(){
    const sec=+elTimerSec.value;
    if(!sec){ elTimer.textContent='Timer: off'; elTimer.style.color='var(--ink)'; return; }
    remaining=sec; renderTimer(); stopTimer();
    tick=setInterval(()=>{
      remaining--;
      if(remaining>0){ sfx.tick(); renderTimer(); return; }
      // timeout
      stopTimer();
      if (!current || current._done) { renderTimer(); return; } // guard
      current._done = true;
      bad++;
      setCurrentStreak(0); renderStreak();
      elFeedback.textContent='Time out — next!'; elFeedback.className='feedback no';
      sfx.timeout();
      consumeRound();
      afterOverlayThenNext(flashAsync(fxBad,BAD_POOL,700));
    },1000);
  }
  function stopTimer(){ if(tick){ clearInterval(tick); tick=null; } }
  function renderTimer(){
    const warn=remaining<=Math.max(3,Math.floor(+elTimerSec.value*0.25));
    elTimer.textContent='⏱ '+remaining+'s'; elTimer.style.color=warn?'var(--warn)':'var(--ink)';
  }

  // UI events
  elDiff.addEventListener('input',()=>{ elDiffVal.textContent=elDiff.value; });
  elTimerSec.addEventListener('input',()=>{ elTimerVal.textContent=elTimerSec.value+'s'; });

  elStart.addEventListener('click',start);
  elReset.addEventListener('click',reset);

  elBtn1.addEventListener('click',()=>{ handleSubmit(elAns1.value.trim(),'solo'); });
  elBtnP1.addEventListener('click',()=>{ if(elPlayers.value==='2' && turn==='p1') handleSubmit(elP1.value.trim(),'p1'); });
  elBtnP2.addEventListener('click',()=>{ if(elPlayers.value==='2' && turn==='p2') handleSubmit(elP2.value.trim(),'p2'); });

  elAns1.addEventListener('keydown',e=>{ if(e.key==='Enter')handleSubmit(elAns1.value.trim(),'solo'); if(e.key==='Escape')elAns1.value=''; });
  elP1  .addEventListener('keydown',e=>{ if(e.key==='Enter'&&turn==='p1')handleSubmit(elP1.value.trim(),'p1'); if(e.key==='Escape')elP1.value=''; });
  elP2  .addEventListener('keydown',e=>{ if(e.key==='Enter'&&turn==='p2')handleSubmit(elP2.value.trim(),'p2'); if(e.key==='Escape')elP2.value=''; });

  // Skip shortcut: ignore if typing in an input
  window.addEventListener('keydown',e=>{
    if(e.key && e.key.toLowerCase()==='s'){
      const ae = document.activeElement;
      if (ae && ae.tagName === 'INPUT') return;
      skip();
    }
  });

  [elAns1,elP1,elP2].forEach(inp=>{
    inp.addEventListener('input',()=>{ inp.value=inp.value.replace(/[^\d-]/g,'').replace(/(?!^)-/g,''); });
  });

  // Init
  setRandomBgm(); attemptAutoplay();
  fxGoodImg.src = "images/Macky-Correct-2.jpg";
  fxBadImg.src  = "images/Macky-Incorrect-1.png";
  fxGoodVid.style.display='none'; fxBadVid.style.display='none';

  stopTimer(); running=false; current=null; qCount=0;
  elFormula.textContent='—'; elFeedback.textContent=' '; elFeedback.className='feedback'; elTimer.textContent='Timer: off';
  elP1Score.textContent='0 / 0'; elP2Score.textContent='0 / 0'; elLead.textContent='—';
  elQIndex.textContent='0'; renderStreak();
  uiMode();
})();
</script>
