<!-- Audio elements -->
<audio id="bgm" src="" loop preload="auto"></audio>
<audio id="sndCorrect" src="sounds/correct.mp3" preload="auto"></audio>
<audio id="sndWrong"   src="sounds/wrong.mp3"   preload="auto"></audio>
<audio id="sndFinish"  src="sounds/finish.mp3"  preload="auto"></audio>

<script>
(function(){
  // ===== Constants =====
  const NAME_P1 = 'Aliah';
  const NAME_P2 = 'Aliana';

  // --- Music pool (filenames inside /sounds) ---
  const MUSIC_TRACKS = [
    "Confused and Angry Robots.mp3",
    "Delightful Stroll.mp3",
    "Forest Theme - D Minor - Jordan Ottesen.mp3",
    "Rainbow Lollipop.mp3",
    "Space Knights.mp3",
    "Water Theme - G Major - Jordan Ottesen.mp3"
  ];
  function setRandomBgm(){
    if (!MUSIC_TRACKS.length) return;
    const pick = MUSIC_TRACKS[Math.floor(Math.random()*MUSIC_TRACKS.length)];
    BGM.src = "sounds/" + pick;
    console.log('BGM src:', BGM.src);
  }
  function attemptAutoplay(){
    BGM.volume = +elMusicVol.value;
    BGM.play().catch(() => {
      const resume = () => {
        if (AC && AC.state === 'suspended') AC.resume();
        BGM.play().catch(()=>{});
        document.removeEventListener('pointerdown', resume);
        document.removeEventListener('keydown', resume);
      };
      document.addEventListener('pointerdown', resume, { once:true });
      document.addEventListener('keydown',   resume, { once:true });
    });
  }

  // ===== DOM =====
  var $=function(s){return document.querySelector(s);}
  var elMode=$('#mode'), elDiff=$('#difficulty'), elDiffVal=$('#diffVal');
  var elTimerSec=$('#timerSec'), elTimerVal=$('#timerVal');
  var elRounds=$('#rounds'), elPlayers=$('#players');

  var elMusicOn=$('#musicOn'), elMusicVol=$('#musicVol'), BGM=$('#bgm');
  var elSoundOn=$('#soundOn'), elVol=$('#volume'), SND_OK=$('#sndCorrect'), SND_NO=$('#sndWrong'), SND_FINISH=$('#sndFinish');

  var elStart=$('#btnStart'), elReset=$('#btnReset');
  var elSingle=$('#singleRows'), elMulti=$('#multiRows');
  var elAns1=$('#answer1'), elBtn1=$('#btnSubmit1');
  var elP1=$('#answerP1'), elP2=$('#answerP2');
  var elBtnP1=$('#btnSubmitP1'), elBtnP2=$('#btnSubmitP2');
  var rowP1=$('#rowP1'), rowP2=$('#rowP2');

  var elFormula=$('#formula'), elFeedback=$('#feedback');
  var elQIndex=$('#qIndex'), elTimer=$('#timer');
  var elVersus=$('#versus'), elP1Score=$('#p1Score'), elP2Score=$('#p2Score'), elLead=$('#lead');
  var elLblP1=$('#lblP1'), elLblP2=$('#lblP2'), elTurn=$('#turnBanner');

  var fxGood=$('#fxGood'), fxBad=$('#fxBad'), fxGoodImg=$('#fxGoodImg'), fxBadImg=$('#fxBadImg');

  // Turn overlay
  var overlay=$('#turnOverlay'), overlayText=$('#turnText'), overlayAvatar=$('#turnAvatar'), btnBeginTurn=$('#btnBeginTurn');

  // ===== State =====
  var GOOD_CANDIDATES=["images/correct1.webp","images/correct2.webp"];
  var BAD_CANDIDATES =["images/wrong1.webp"];
  var GOOD_IMGS=[], BAD_IMGS=[];
  var P1_IMG="players/p1.png";
  var P2_IMG="players/p2.png";

  var running=false, current=null, qCount=0;
  var good=0,bad=0;
  var p1={ok:0,no:0,played:0}, p2={ok:0,no:0,played:0};
  var tick=null, remaining=0;
  var turn='p1';
  var awaitingTurnStart=false;

  // ===== preload & filter images =====
  function filterExisting(candidates, cb){
    var out=[], i=0;
    function tryNext(){
      if(i>=candidates.length){ cb(out); return; }
      var src=candidates[i++], img=new Image();
      img.onload=function(){ out.push(src); tryNext(); };
      img.onerror=tryNext; img.src=src;
    }
    tryNext();
  }
  filterExisting(GOOD_CANDIDATES,function(arr){ GOOD_IMGS=arr.length?arr:GOOD_CANDIDATES.slice(0,1); fxGoodImg.src=GOOD_IMGS[0]; });
  filterExisting(BAD_CANDIDATES, function(arr){ BAD_IMGS =arr.length?arr:BAD_CANDIDATES.slice(0,1);  fxBadImg.src =BAD_IMGS[0]; });

  // ===== Music =====
  function updateMusic(){
    BGM.volume=+elMusicVol.value;
    if(elMusicOn.value==="1"){
      BGM.play().catch(function(){});
    }else{
      BGM.pause();
    }
  }
  elMusicOn.addEventListener('change',updateMusic);
  elMusicVol.addEventListener('input',updateMusic);

  // ===== Turn overlay =====
  function showTurnOverlay(){
    if(elPlayers.value!=='2') return;
    overlayText.textContent = 'Next up: ' + (turn==='p1'?NAME_P1:NAME_P2);
    overlayAvatar.src = (turn==='p1')? P1_IMG : P2_IMG;
    overlay.classList.add('show');
    awaitingTurnStart = true;
  }
  function hideTurnOverlay(){ overlay.classList.remove('show'); awaitingTurnStart=false; }

  // Player handoff: randomize music + play
  btnBeginTurn.addEventListener('click', function(){
    hideTurnOverlay();
    setRandomBgm();
    attemptAutoplay();
    qCount = 0; elQIndex.textContent = '0';
    setRowVis();
    next(true);
  });

  // ===== Game flow =====
  function start(){
    if(running) return;
    running=true; qCount=0; good=bad=0; p1={ok:0,no:0,played:0}; p2={ok:0,no:0,played:0};
    elStart.textContent='Running…'; elStart.disabled=true;

    // New match: randomize music + play
    setRandomBgm();
    attemptAutoplay();

    if(elPlayers.value==="2"){
      turn = (Math.random()<0.5)?'p1':'p2';
      updateTurnBanner();
      qCount = 0; elQIndex.textContent = '0';
      showTurnOverlay();
    }else{
      elAns1.disabled=false; next(true); elAns1.focus();
    }
    uiMode();
  }

  function finish(){
    if (SND_FINISH) { try { SND_FINISH.currentTime = 0; SND_FINISH.play(); } catch(e){} }
    running=false; elStart.textContent='Start ▶'; elStart.disabled=false;
    showFinal('Match finished!');
  }

  // ===== Init on app load =====
  setRandomBgm();     // pick one track immediately
  attemptAutoplay();  // try to start it immediately

  // [rest of your existing code...]
})();
</script>
